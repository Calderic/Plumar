---
import { getPlumarConfig } from '../utils/config.js';
import { createThemeRenderer } from '../utils/theme-renderer.js';
import FallbackLayout from '../layouts/fallback.astro';

const { pageType = 'default', ...pageData } = Astro.props;

// è·å–é…ç½®å’Œä¸»é¢˜æ¸²æŸ“å™¨
const config = getPlumarConfig();
const themeRenderer = createThemeRenderer(config);

// å°è¯•åŠ è½½ä¸»é¢˜å¸ƒå±€
let ThemeLayout = null;
let layoutSource = 'fallback';

// 1. å°è¯•åŠ è½½ç‰¹å®šé¡µé¢ç±»å‹çš„å¸ƒå±€ (home.astro, post.astro ç­‰)
if (pageType !== 'default') {
  try {
    const layoutPath = `@theme/layouts/${pageType}.astro`;
    const layoutModule = await import(layoutPath);
    ThemeLayout = layoutModule.default;
    layoutSource = `theme:${pageType}`;
  } catch {
    // ç»§ç»­å°è¯•å…¶ä»–å¸ƒå±€
  }
}

// 2. å°è¯•åŠ è½½é»˜è®¤ä¸»é¢˜å¸ƒå±€ (default.astro)
if (!ThemeLayout) {
  try {
    const layoutPath = '@theme/layouts/default.astro';
    const layoutModule = await import(layoutPath);
    ThemeLayout = layoutModule.default;
    layoutSource = 'theme:default';
  } catch {
    // ç»§ç»­å°è¯•å…¶ä»–å¸ƒå±€
  }
}

// 3. ä½¿ç”¨å†…ç½® fallback å¸ƒå±€
if (!ThemeLayout) {
  ThemeLayout = FallbackLayout;
  layoutSource = 'fallback';
}

// å‡†å¤‡ä¼ é€’ç»™å¸ƒå±€çš„æ•°æ®
const layoutProps = {
  ...pageData,
  pageType,
  language: config.language || 'zh-CN'
};

// å¼€å‘æ¨¡å¼ä¸‹æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
const isDev = import.meta.env.DEV;
if (isDev) {
  console.log(`ğŸ¨ [ThemePageRenderer] é¡µé¢ç±»å‹: ${pageType}, å¸ƒå±€æ¥æº: ${layoutSource}`);
}
---

<!-- å¼€å‘æ¨¡å¼ä¸‹çš„è°ƒè¯•æ³¨é‡Š -->
{isDev && (
  <!-- 
  Plumar Theme Debug Info:
  - Page Type: {pageType}
  - Layout Source: {layoutSource}
  - Theme: {config.theme || 'none'}
  - Config: {JSON.stringify(config, null, 2)}
  -->
)}

<ThemeLayout {...layoutProps}>
  <slot />
</ThemeLayout> 