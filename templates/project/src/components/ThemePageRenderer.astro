---
import { getPlumarConfig } from '../utils/config.js';
import FallbackLayout from '../layouts/fallback.astro';

// é™æ€å¯¼å…¥æ‰€æœ‰å¯èƒ½çš„ä¸»é¢˜å¸ƒå±€
let HomeLayout, DefaultLayout, PostLayout;
let layoutSource = 'fallback';

try {
  // å°è¯•å¯¼å…¥ä¸»é¢˜å¸ƒå±€
  HomeLayout = (await import('@theme/layouts/home.astro')).default;
} catch {
  // ä¸»é¢˜æ²¡æœ‰ home å¸ƒå±€
}

try {
  DefaultLayout = (await import('@theme/layouts/default.astro')).default;
} catch {
  // ä¸»é¢˜æ²¡æœ‰ default å¸ƒå±€
}

try {
  PostLayout = (await import('@theme/layouts/PostLayout.astro')).default;
} catch {
  // ä¸»é¢˜æ²¡æœ‰ PostLayout å¸ƒå±€
}

const { pageType = 'default', ...pageData } = Astro.props;

// è·å–é…ç½®
const config = getPlumarConfig();

// é€‰æ‹©åˆé€‚çš„å¸ƒå±€
let ThemeLayout = FallbackLayout;

if (pageType === 'home' && HomeLayout) {
  ThemeLayout = HomeLayout;
  layoutSource = 'theme:home';
} else if (pageType === 'post' && PostLayout) {
  ThemeLayout = PostLayout;
  layoutSource = 'theme:post';
} else if (DefaultLayout) {
  ThemeLayout = DefaultLayout;
  layoutSource = 'theme:default';
} else {
  ThemeLayout = FallbackLayout;
  layoutSource = 'fallback';
}

// å‡†å¤‡ä¼ é€’ç»™å¸ƒå±€çš„æ•°æ®
const layoutProps = {
  ...pageData,
  pageType,
  language: config.language || 'zh-CN'
};

// å¼€å‘æ¨¡å¼ä¸‹æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
const isDev = import.meta.env.DEV;
if (isDev) {
  console.log(`ğŸ¨ [ThemePageRenderer] é¡µé¢ç±»å‹: ${pageType}, å¸ƒå±€æ¥æº: ${layoutSource}`);
  console.log(`ğŸ¨ [ThemePageRenderer] ä¸»é¢˜: ${config.theme || 'none'}`);
  console.log(`ğŸ¨ [ThemePageRenderer] å¯ç”¨å¸ƒå±€: Home=${!!HomeLayout}, Default=${!!DefaultLayout}, Post=${!!PostLayout}`);
}
---

<!-- å¼€å‘æ¨¡å¼ä¸‹çš„è°ƒè¯•æ³¨é‡Š -->
{isDev && (
  <!-- 
  Plumar Theme Debug Info:
  - Page Type: {pageType}
  - Layout Source: {layoutSource}
  - Theme: {config.theme || 'none'}
  - Available Layouts: Home={!!HomeLayout}, Default={!!DefaultLayout}, Post={!!PostLayout}
  -->
)}

<ThemeLayout {...layoutProps}>
  <slot />
</ThemeLayout> 